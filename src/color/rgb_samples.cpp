/*
Copyright (C) 2017-2021 Topological Manifold

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
Brian Smits.
An RGB-to-Spectrum Conversion for Reflectances.
Journal of Graphics Tools, 1999.
*/

/*
Matt Pharr, Wenzel Jakob, Greg Humphreys.
Physically Based Rendering. From theory to implementation. Third edition.
Elsevier, 2017.

5.2.2 RGB color
*/

#include "rgb_samples.h"

#include "average.h"

#include <span>

namespace ns::color
{
namespace
{
using ComputeType = double;

// clang-format off
constexpr ComputeType WAVES[] =
{
         3.80000000000000000e+02L,  3.90967741935483871e+02L,
         4.01935483870967742e+02L,  4.12903225806451613e+02L,
         4.23870967741935484e+02L,  4.34838709677419355e+02L,
         4.45806451612903226e+02L,  4.56774193548387097e+02L,
         4.67741935483870968e+02L,  4.78709677419354839e+02L,
         4.89677419354838710e+02L,  5.00645161290322581e+02L,
         5.11612903225806452e+02L,  5.22580645161290323e+02L,
         5.33548387096774194e+02L,  5.44516129032258065e+02L,
         5.55483870967741935e+02L,  5.66451612903225806e+02L,
         5.77419354838709677e+02L,  5.88387096774193548e+02L,
         5.99354838709677419e+02L,  6.10322580645161290e+02L,
         6.21290322580645161e+02L,  6.32258064516129032e+02L,
         6.43225806451612903e+02L,  6.54193548387096774e+02L,
         6.65161290322580645e+02L,  6.76129032258064516e+02L,
         6.87096774193548387e+02L,  6.98064516129032258e+02L,
         7.09032258064516129e+02L,  7.20000000000000000e+02L
};
constexpr ComputeType REFLECTANCE_WHITE[] =
{
         9.99380736354927968e-01L,  9.99010064233787909e-01L,
         9.98945634518869308e-01L,  9.99733949831214663e-01L,
         9.99670382580426065e-01L,  9.99954956086727464e-01L,
         9.99849410547303918e-01L,  9.99921685571425911e-01L,
         9.99953843638710649e-01L,  9.99889657384648634e-01L,
         9.99544085027233797e-01L,  9.98835730160979374e-01L,
         9.98569055908795633e-01L,  9.98901701207143611e-01L,
         9.98934339673956728e-01L,  9.99510384373775929e-01L,
         9.99996129493104013e-01L,  9.99885079422185963e-01L,
         9.99972759924712018e-01L,  9.99881331517562866e-01L,
         9.99925770639425116e-01L,  1.00000000000000000e+00L,
         9.99980079040801217e-01L,  9.99847888294061238e-01L,
         9.99822352471182563e-01L,  9.99973450351907545e-01L,
         9.98751972769086005e-01L,  9.97056528279591681e-01L,
         9.97578680597021816e-01L,  9.97836225768635399e-01L,
         9.97715359593619233e-01L,  9.98214412939439244e-01L
};
constexpr ComputeType REFLECTANCE_CYAN[] =
{
         9.80150600556353391e-01L,  9.72060047122283000e-01L,
         9.53000749255865531e-01L,  9.74111612875754429e-01L,
         9.48531819845497171e-01L,  9.80870786511745196e-01L,
         9.82782816971530693e-01L,  9.91501579892406837e-01L,
         9.58142135507227932e-01L,  9.82795350004738499e-01L,
         9.90948596311494456e-01L,  9.91670604817792012e-01L,
         9.91375805460527615e-01L,  9.91741041700931913e-01L,
         9.90735075703917834e-01L,  9.91050849813070900e-01L,
         9.92943045638355004e-01L,  9.93236580926926904e-01L,
         9.83884868984692740e-01L,  5.86783909011169502e-01L,
         1.69761480565329054e-01L, -7.18116626466768285e-03L,
        -1.43219535835639408e-04L, -7.06808946902441875e-03L,
        -2.04306249165174189e-03L,  6.20387061791724970e-04L,
         1.15559462938346711e-02L, -4.20400107689385821e-03L,
         1.61119353643276939e-02L,  4.63139721196238491e-03L,
         5.53034791556553280e-03L,  2.37723473713202203e-02L
};
constexpr ComputeType REFLECTANCE_MAGENTA[] =
{
         9.35690340711578861e-01L,  9.31594538649946680e-01L,
         9.25069892096060387e-01L,  9.37626527259241005e-01L,
         9.59852993919099617e-01L,  9.56788724043131311e-01L,
         9.61919539496043474e-01L,  9.37850493702369170e-01L,
         9.50329821111374873e-01L,  9.61402793178808612e-01L,
         6.02623131990092986e-01L,  2.35398698017474060e-03L,
         6.14932966056431270e-03L,  2.66660181473281008e-03L,
        -4.81948985442699221e-11L, -8.52590115369981569e-03L,
         3.19388217966982187e-03L, -2.88350005867388801e-03L,
         2.08967630195584259e-01L,  5.94239431190495271e-01L,
         9.17421595462257433e-01L,  9.14867153248899112e-01L,
         9.57482787840608918e-01L,  9.39954182662200766e-01L,
         8.91265181688918995e-01L,  8.02393426970428814e-01L,
         8.93110479605475849e-01L,  8.91737161123531519e-01L,
         9.37354313210240431e-01L,  8.12206843405773871e-01L,
         8.39025590784874487e-01L,  7.98702974025201518e-01L
};
constexpr ComputeType REFLECTANCE_YELLOW[] =
{
         5.24591036020140289e-03L, -4.51580230644800604e-03L,
        -4.94436718647195666e-03L, -6.07700772550094463e-03L,
        -5.61792837161261081e-03L, -2.05511615916408432e-03L,
         1.57931953030807128e-02L,  9.04390442858746813e-02L,
         1.99682650627003744e-01L,  3.40398117374250020e-01L,
         5.07842601405576022e-01L,  7.00282719080681071e-01L,
         8.67810797967998204e-01L,  9.84449326370218536e-01L,
         9.89486312518672584e-01L,  9.89313787905952924e-01L,
         9.89176297450020447e-01L,  9.89822506422591508e-01L,
         9.89695064076050790e-01L,  9.89309290244656969e-01L,
         9.89276001937368310e-01L,  9.89748649942612135e-01L,
         9.89506409172741130e-01L,  9.89685459145323576e-01L,
         9.89263777718686454e-01L,  9.89608543477306646e-01L,
         9.89020113133555423e-01L,  9.89025038868969197e-01L,
         9.86066987171692944e-01L,  9.87552025151528845e-01L,
         9.82158528138873832e-01L,  9.78047436636249379e-01L
};
constexpr ComputeType REFLECTANCE_RED[] =
{
         1.55997785342252032e-01L,  1.11490280821177665e-01L,
         1.16778017744866194e-01L,  1.07018312263777560e-01L,
         7.43420523266088290e-02L,  3.03096199289303175e-02L,
        -1.01626522980784225e-02L,  1.69892334200986116e-02L,
         5.02630489659156108e-03L,  1.28510367972176597e-02L,
        -5.60575947199607079e-03L, -1.73585225131932144e-03L,
        -9.94950447067999809e-03L, -2.76461478672313746e-03L,
        -1.01552276052200036e-02L, -7.55014026684393269e-03L,
        -2.13346057986909914e-03L,  6.60674656248173581e-03L,
        -7.67287873255564652e-03L,  5.71950932235832044e-01L,
         9.30132247996551031e-01L,  9.35403794228067964e-01L,
         9.44831070745062007e-01L,  9.33924422789970676e-01L,
         9.40437325570486538e-01L,  9.49092742990545801e-01L,
         9.25678224001604377e-01L,  9.49130586011745270e-01L,
         9.17140694407645896e-01L,  9.27419055689412075e-01L,
         8.79915528685976223e-01L,  9.29024981082823942e-01L
};
constexpr ComputeType REFLECTANCE_GREEN[] =
{
         2.49344100400842716e-03L, -4.72211484124978546e-03L,
        -1.18085649746694811e-02L, -8.89883967644149176e-03L,
        -1.17886600157558440e-02L, -7.45098209909257278e-03L,
        -7.52486423106655134e-03L, -8.80514740321428936e-03L,
         6.16143939281441552e-02L,  3.72431714551406889e-01L,
         7.08143137650019683e-01L,  9.07026763446355910e-01L,
         9.39758799930177524e-01L,  9.41062669555882803e-01L,
         9.40555492684456262e-01L,  9.41075800577645505e-01L,
         9.40555822665642194e-01L,  9.40293393587044779e-01L,
         9.03667933122363709e-01L,  5.94664250255206750e-01L,
         2.42786761650193278e-01L,  8.84801159116989193e-03L,
        -2.89852089602761574e-03L, -4.25675994574574706e-03L,
        -6.48752153715503443e-03L, -8.50330501837922789e-03L,
        -8.08558234579853478e-03L, -7.87638842794667442e-03L,
        -7.40535001955268911e-03L, -7.87325537177729383e-06L,
         5.11044452276384394e-03L, -2.61121726185305951e-03L
};
constexpr ComputeType REFLECTANCE_BLUE[] =
{
         9.33691696784997971e-01L,  9.30554487242068795e-01L,
         9.36790544643618106e-01L,  9.36699035009322611e-01L,
         9.33425130926987645e-01L,  9.41371956197645021e-01L,
         9.40832106297760928e-01L,  9.41016965909016179e-01L,
         9.27049592782754228e-01L,  7.43772642209018398e-01L,
         5.27805703116197678e-01L,  3.11828508845327923e-01L,
         1.28863217016504494e-01L,  1.78013626466347052e-02L,
        -4.81196981618005510e-06L, -3.98996181178051497e-04L,
        -3.94658518076619082e-04L,  1.64443693872507748e-03L,
         3.57621026810711227e-03L, -5.18575830170023722e-04L,
        -4.11430089544337748e-05L,  7.14076761099206696e-03L,
         2.42770289560838883e-02L,  3.59213570601116458e-02L,
         4.65760733262096105e-02L,  4.66762149625706002e-02L,
         4.68821595497938004e-02L,  3.74954274187325326e-02L,
         2.87053919240396853e-02L,  1.99924498915997999e-02L,
         6.54992982931130487e-03L,  3.92767378450882033e-03L
};
constexpr ComputeType ILLUMINATION_D65_WHITE[] =
{
         1.08843725540862790e+00L,  1.08862481764221886e+00L,
         1.08852864841112296e+00L,  1.08754789227492599e+00L,
         1.08814959552854118e+00L,  1.08866707546141250e+00L,
         1.08869993804043719e+00L,  1.08866739857709871e+00L,
         1.08828019349555682e+00L,  1.08860879044438308e+00L,
         1.08842804072306110e+00L,  1.08835294214171618e+00L,
         1.08869993679075039e+00L,  1.07977093123569867e+00L,
         1.06717575340701276e+00L,  1.06289920313681985e+00L,
         1.06258287450969591e+00L,  9.88643045590308911e-01L,
         9.84392081631450422e-01L,  9.35168475563583623e-01L,
         8.99734809077019415e-01L,  8.70238071495368470e-01L,
         8.61132299358906450e-01L,  8.46446201033641987e-01L,
         8.42710419509765107e-01L,  8.36386466588298072e-01L,
         8.30290560252375465e-01L,  8.28177420869470216e-01L,
         8.24760495140825722e-01L,  8.28196779491781387e-01L,
         8.28811309251699768e-01L,  8.31060993161959694e-01L
};
constexpr ComputeType ILLUMINATION_D65_CYAN[] =
{
         1.06672048454303559e+00L,  1.06034741150098322e+00L,
         1.06788257538049014e+00L,  1.06887718859035608e+00L,
         1.06878081930165147e+00L,  1.06923078794654391e+00L,
         1.06932735419142211e+00L,  1.06957586817121841e+00L,
         1.06866179291765517e+00L,  1.06950446366012675e+00L,
         1.06915649828887527e+00L,  1.06913381891321535e+00L,
         1.06858271662040338e+00L,  1.06941397092763246e+00L,
         1.06869410204867621e+00L,  1.06853240810318550e+00L,
         1.06813375474382166e+00L,  1.04569889445512643e+00L,
         8.52650806722533572e-01L,  5.75601700761629531e-01L,
         2.78007104729263932e-01L,  9.03052583541512771e-02L,
        -1.09648955128088428e-02L, -1.14296635232046979e-02L,
        -1.04918611746007903e-02L, -1.12912927443347896e-02L,
        -4.75334545070380411e-03L, -7.52740627777415995e-03L,
        -8.91463684272796042e-03L, -5.20722225840521309e-03L,
        -4.27544577452284181e-03L, -1.18027102958491916e-02L
};
constexpr ComputeType ILLUMINATION_D65_MAGENTA[] =
{
         9.76128678728814259e-01L,  9.96424116321229181e-01L,
         1.01333886575091836e+00L,  1.01290929980056110e+00L,
         1.01597571011938559e+00L,  1.01111531062863769e+00L,
         1.00955152620218014e+00L,  1.01006150137386919e+00L,
         1.01865526471947399e+00L,  1.02023493668055831e+00L,
         8.99790319307091413e-01L,  5.19483284862703565e-01L,
         7.92346611376407439e-02L,  8.27629299789851012e-05L,
        -2.17272829598472291e-03L, -1.05859449315233748e-03L,
        -7.27470068133996522e-11L, -2.56653051502440737e-04L,
         1.36148139538725642e-02L,  2.43593450155932395e-01L,
         4.97932405252825505e-01L,  8.56113065737196366e-01L,
         1.00612041881798686e+00L,  1.02463757312390347e+00L,
         1.00113723256419473e+00L,  9.60121959023534810e-01L,
         9.65804849394241938e-01L,  1.01482719942960142e+00L,
         9.25448144330480726e-01L,  1.00768975249152337e+00L,
         1.00081964686608149e+00L,  9.55328089802104929e-01L
};
constexpr ComputeType ILLUMINATION_D65_YELLOW[] =
{
         2.61228725058502672e-03L,  3.73381741434681679e-03L,
        -1.37470083772423023e-04L,  3.40673503575522206e-04L,
        -2.42992470475017404e-04L, -4.71817887119696915e-05L,
        -2.29985921935251544e-04L, -7.34658477335327202e-05L,
         4.67649717975478219e-02L,  4.56597782830517052e-01L,
         9.68960375594157819e-01L,  9.72488199036829482e-01L,
         9.75771963459980629e-01L,  9.75469049389690812e-01L,
         9.75520239314917048e-01L,  9.75818338410657127e-01L,
         9.75540705689125986e-01L,  9.75380039484735950e-01L,
         9.75687538068331417e-01L,  9.75502488688509195e-01L,
         9.75153508447147210e-01L,  9.73953925150460753e-01L,
         9.45150176072125148e-01L,  7.92604401086527299e-01L,
         6.94170882090793029e-01L,  6.19762979524559610e-01L,
         5.69681075293077099e-01L,  5.60440241954059837e-01L,
         5.59211759717773926e-01L,  5.31904165569178189e-01L,
         5.27607947469882044e-01L,  5.48006201633870038e-01L
};
constexpr ComputeType ILLUMINATION_D65_RED[] =
{
         5.14902719895935987e-02L,  5.23352920647312050e-02L,
         5.71791004546473303e-02L,  5.29224454714988107e-02L,
         4.34518591068473806e-02L,  3.57749471972174868e-02L,
         2.29863414173527118e-02L,  3.66885690398859087e-03L,
        -5.27806207140252997e-04L,  9.08131578643071998e-04L,
         3.51428755980356261e-04L, -4.08142973294348447e-04L,
        -8.80275023648407557e-05L, -1.16276152202816007e-04L,
        -1.36694699952666224e-04L, -1.88674595293870326e-04L,
        -4.69986413525161958e-04L,  2.56505431063074295e-02L,
         1.51214978739896477e-01L,  3.30051870836711947e-01L,
         5.39807606937170115e-01L,  7.18947950809161185e-01L,
         8.38964218713314058e-01L,  9.07197401567125694e-01L,
         9.30583080772871885e-01L,  9.40163636924903456e-01L,
         9.28001339900536237e-01L,  9.36729014217554723e-01L,
         9.16974491545281212e-01L,  9.32982021202209855e-01L,
         9.30459072905025497e-01L,  9.38435782142845398e-01L
};
constexpr ComputeType ILLUMINATION_D65_GREEN[] =
{
         2.36866946212582405e-02L,  3.71062961832649349e-02L,
         5.84060479600054510e-03L,  6.69338869414430517e-03L,
         2.04790039424425173e-04L,  6.89582362583819454e-12L,
        -2.03500895999711266e-02L,  1.47476848254926591e-02L,
         2.63700545388563566e-03L,  3.05817663284619956e-01L,
         9.56649605552102877e-01L,  9.72136760797826516e-01L,
         9.71394238916356123e-01L,  9.74883986628842569e-01L,
         9.55361970541667493e-01L,  9.72946134566240239e-01L,
         9.76079687544096131e-01L,  9.75138996360657706e-01L,
         9.62758014998426170e-01L,  9.12050966608980440e-01L,
        -4.87372225934556286e-03L,  1.04759508293905440e-03L,
         6.27502338112797577e-03L,  6.96664127860691920e-04L,
         2.03204453767935611e-02L,  4.84508334929494629e-03L,
         1.37046499193294903e-03L,  1.54481685047041216e-04L,
        -6.08258720022606010e-03L,  9.64737423928180293e-03L,
         3.98919964486784615e-02L,  2.00015432298309495e-02L
};
constexpr ComputeType ILLUMINATION_D65_BLUE[] =
{
         9.94819291156219476e-01L,  9.91805434848301304e-01L,
         9.92937362909891208e-01L,  9.91046964292854660e-01L,
         9.95707701382152810e-01L,  9.95567369516954237e-01L,
         9.96009031116701138e-01L,  9.95687217401890590e-01L,
         9.94009306261368408e-01L,  9.94904795160633904e-01L,
         9.81201574701357382e-01L,  3.06837005253335460e-01L,
        -1.81220258112826937e-03L, -1.21962957813625183e-03L,
        -1.35121209785802319e-03L, -1.22005083803355236e-03L,
        -1.80951591448820634e-03L,  1.18781296872424438e-03L,
        -1.51477018137418751e-03L, -1.22628925757682660e-03L,
        -1.66265462585615375e-03L, -1.15996766152540913e-03L,
         9.70944634437469027e-03L,  2.94427547458354713e-02L,
         8.35476519188164124e-02L,  1.30568644915669663e-01L,
         1.46204989172792371e-01L,  1.40025628487259274e-01L,
         1.56455649534440883e-01L,  1.59969434311673236e-01L,
         1.48413596878880560e-01L,  1.79464696119357281e-01L
};
// clang-format on

static_assert(std::is_sorted(std::cbegin(WAVES), std::cend(WAVES)));
static_assert(std::span(WAVES).front() == RGB_SAMPLES_MIN_WAVELENGTH);
static_assert(std::span(WAVES).back() == RGB_SAMPLES_MAX_WAVELENGTH);

template <std::size_t COUNT>
std::vector<double> rgb_samples(const ComputeType (&samples)[COUNT], int from, int to, int count)
{
        static_assert(COUNT == 32);

        return average<double>(std::span(WAVES), std::span(samples), from, to, count);
}
}

std::vector<double> rgb_reflectance_white_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_WHITE, from, to, count);
}

std::vector<double> rgb_reflectance_cyan_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_CYAN, from, to, count);
}

std::vector<double> rgb_reflectance_magenta_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_MAGENTA, from, to, count);
}

std::vector<double> rgb_reflectance_yellow_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_YELLOW, from, to, count);
}

std::vector<double> rgb_reflectance_red_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_RED, from, to, count);
}

std::vector<double> rgb_reflectance_green_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_GREEN, from, to, count);
}

std::vector<double> rgb_reflectance_blue_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_BLUE, from, to, count);
}

std::vector<double> rgb_illumination_d65_white_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_D65_WHITE, from, to, count);
}

std::vector<double> rgb_illumination_d65_cyan_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_D65_CYAN, from, to, count);
}

std::vector<double> rgb_illumination_d65_magenta_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_D65_MAGENTA, from, to, count);
}

std::vector<double> rgb_illumination_d65_yellow_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_D65_YELLOW, from, to, count);
}

std::vector<double> rgb_illumination_d65_red_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_D65_RED, from, to, count);
}

std::vector<double> rgb_illumination_d65_green_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_D65_GREEN, from, to, count);
}

std::vector<double> rgb_illumination_d65_blue_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_D65_BLUE, from, to, count);
}
}
