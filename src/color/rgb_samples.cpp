/*
Copyright (C) 2017-2021 Topological Manifold

This program is free software: you can redistribute it and/or modify
it under the terms of the GNU General Public License as published by
the Free Software Foundation, either version 3 of the License, or
(at your option) any later version.

This program is distributed in the hope that it will be useful,
but WITHOUT ANY WARRANTY; without even the implied warranty of
MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
GNU General Public License for more details.

You should have received a copy of the GNU General Public License
along with this program.  If not, see <http://www.gnu.org/licenses/>.
*/

/*
Brian Smits.
An RGB-to-Spectrum Conversion for Reflectances.
Journal of Graphics Tools, 1999.
*/

/*
Matt Pharr, Wenzel Jakob, Greg Humphreys.
Physically Based Rendering. From theory to implementation. Third edition.
Elsevier, 2017.

5.2.2 RGB color
*/

#include "rgb_samples.h"

#include "average.h"

#include <src/com/error.h>
#include <src/com/print.h>

#include <array>

namespace ns::color
{
namespace
{
using ComputeType = double;

// clang-format off
constexpr ComputeType WAVES[] =
{
         3.80000000000000000e+02L,  3.90967741935483871e+02L,
         4.01935483870967742e+02L,  4.12903225806451613e+02L,
         4.23870967741935484e+02L,  4.34838709677419355e+02L,
         4.45806451612903226e+02L,  4.56774193548387097e+02L,
         4.67741935483870968e+02L,  4.78709677419354839e+02L,
         4.89677419354838710e+02L,  5.00645161290322581e+02L,
         5.11612903225806452e+02L,  5.22580645161290323e+02L,
         5.33548387096774194e+02L,  5.44516129032258065e+02L,
         5.55483870967741935e+02L,  5.66451612903225806e+02L,
         5.77419354838709677e+02L,  5.88387096774193548e+02L,
         5.99354838709677419e+02L,  6.10322580645161290e+02L,
         6.21290322580645161e+02L,  6.32258064516129032e+02L,
         6.43225806451612903e+02L,  6.54193548387096774e+02L,
         6.65161290322580645e+02L,  6.76129032258064516e+02L,
         6.87096774193548387e+02L,  6.98064516129032258e+02L,
         7.09032258064516129e+02L,  7.20000000000000000e+02L
};
constexpr ComputeType REFLECTANCE_WHITE[] =
{
         9.99380736354927968e-01L,  9.99010064233787909e-01L,
         9.98945634518869308e-01L,  9.99733949831214663e-01L,
         9.99670382580426065e-01L,  9.99954956086727464e-01L,
         9.99849410547303918e-01L,  9.99921685571425911e-01L,
         9.99953843638710649e-01L,  9.99889657384648634e-01L,
         9.99544085027233797e-01L,  9.98835730160979374e-01L,
         9.98569055908795633e-01L,  9.98901701207143611e-01L,
         9.98934339673956728e-01L,  9.99510384373775929e-01L,
         9.99996129493104013e-01L,  9.99885079422185963e-01L,
         9.99972759924712018e-01L,  9.99881331517562866e-01L,
         9.99925770639425116e-01L,  1.00000000000000000e+00L,
         9.99980079040801217e-01L,  9.99847888294061238e-01L,
         9.99822352471182563e-01L,  9.99973450351907545e-01L,
         9.98751972769086005e-01L,  9.97056528279591681e-01L,
         9.97578680597021816e-01L,  9.97836225768635399e-01L,
         9.97715359593619233e-01L,  9.98214412939439244e-01L
};
constexpr ComputeType REFLECTANCE_CYAN[] =
{
         9.80150600556353391e-01L,  9.72060047122283000e-01L,
         9.53000749255865531e-01L,  9.74111612875754429e-01L,
         9.48531819845497171e-01L,  9.80870786511745196e-01L,
         9.82782816971530693e-01L,  9.91501579892406837e-01L,
         9.58142135507227932e-01L,  9.82795350004738499e-01L,
         9.90948596311494456e-01L,  9.91670604817792012e-01L,
         9.91375805460527615e-01L,  9.91741041700931913e-01L,
         9.90735075703917834e-01L,  9.91050849813070900e-01L,
         9.92943045638355004e-01L,  9.93236580926926904e-01L,
         9.83884868984692740e-01L,  5.86783909011169502e-01L,
         1.69761480565329054e-01L, -7.18116626466768285e-03L,
        -1.43219535835639408e-04L, -7.06808946902441875e-03L,
        -2.04306249165174189e-03L,  6.20387061791724970e-04L,
         1.15559462938346711e-02L, -4.20400107689385821e-03L,
         1.61119353643276939e-02L,  4.63139721196238491e-03L,
         5.53034791556553280e-03L,  2.37723473713202203e-02L
};
constexpr ComputeType REFLECTANCE_MAGENTA[] =
{
         9.35690340711578861e-01L,  9.31594538649946680e-01L,
         9.25069892096060387e-01L,  9.37626527259241005e-01L,
         9.59852993919099617e-01L,  9.56788724043131311e-01L,
         9.61919539496043474e-01L,  9.37850493702369170e-01L,
         9.50329821111374873e-01L,  9.61402793178808612e-01L,
         6.02623131990092986e-01L,  2.35398698017474060e-03L,
         6.14932966056431270e-03L,  2.66660181473281008e-03L,
        -4.81948985442699221e-11L, -8.52590115369981569e-03L,
         3.19388217966982187e-03L, -2.88350005867388801e-03L,
         2.08967630195584259e-01L,  5.94239431190495271e-01L,
         9.17421595462257433e-01L,  9.14867153248899112e-01L,
         9.57482787840608918e-01L,  9.39954182662200766e-01L,
         8.91265181688918995e-01L,  8.02393426970428814e-01L,
         8.93110479605475849e-01L,  8.91737161123531519e-01L,
         9.37354313210240431e-01L,  8.12206843405773871e-01L,
         8.39025590784874487e-01L,  7.98702974025201518e-01L
};
constexpr ComputeType REFLECTANCE_YELLOW[] =
{
         5.24591036020140289e-03L, -4.51580230644800604e-03L,
        -4.94436718647195666e-03L, -6.07700772550094463e-03L,
        -5.61792837161261081e-03L, -2.05511615916408432e-03L,
         1.57931953030807128e-02L,  9.04390442858746813e-02L,
         1.99682650627003744e-01L,  3.40398117374250020e-01L,
         5.07842601405576022e-01L,  7.00282719080681071e-01L,
         8.67810797967998204e-01L,  9.84449326370218536e-01L,
         9.89486312518672584e-01L,  9.89313787905952924e-01L,
         9.89176297450020447e-01L,  9.89822506422591508e-01L,
         9.89695064076050790e-01L,  9.89309290244656969e-01L,
         9.89276001937368310e-01L,  9.89748649942612135e-01L,
         9.89506409172741130e-01L,  9.89685459145323576e-01L,
         9.89263777718686454e-01L,  9.89608543477306646e-01L,
         9.89020113133555423e-01L,  9.89025038868969197e-01L,
         9.86066987171692944e-01L,  9.87552025151528845e-01L,
         9.82158528138873832e-01L,  9.78047436636249379e-01L
};
constexpr ComputeType REFLECTANCE_RED[] =
{
         1.55997785342252032e-01L,  1.11490280821177665e-01L,
         1.16778017744866194e-01L,  1.07018312263777560e-01L,
         7.43420523266088290e-02L,  3.03096199289303175e-02L,
        -1.01626522980784225e-02L,  1.69892334200986116e-02L,
         5.02630489659156108e-03L,  1.28510367972176597e-02L,
        -5.60575947199607079e-03L, -1.73585225131932144e-03L,
        -9.94950447067999809e-03L, -2.76461478672313746e-03L,
        -1.01552276052200036e-02L, -7.55014026684393269e-03L,
        -2.13346057986909914e-03L,  6.60674656248173581e-03L,
        -7.67287873255564652e-03L,  5.71950932235832044e-01L,
         9.30132247996551031e-01L,  9.35403794228067964e-01L,
         9.44831070745062007e-01L,  9.33924422789970676e-01L,
         9.40437325570486538e-01L,  9.49092742990545801e-01L,
         9.25678224001604377e-01L,  9.49130586011745270e-01L,
         9.17140694407645896e-01L,  9.27419055689412075e-01L,
         8.79915528685976223e-01L,  9.29024981082823942e-01L
};
constexpr ComputeType REFLECTANCE_GREEN[] =
{
         2.49344100400842716e-03L, -4.72211484124978546e-03L,
        -1.18085649746694811e-02L, -8.89883967644149176e-03L,
        -1.17886600157558440e-02L, -7.45098209909257278e-03L,
        -7.52486423106655134e-03L, -8.80514740321428936e-03L,
         6.16143939281441552e-02L,  3.72431714551406889e-01L,
         7.08143137650019683e-01L,  9.07026763446355910e-01L,
         9.39758799930177524e-01L,  9.41062669555882803e-01L,
         9.40555492684456262e-01L,  9.41075800577645505e-01L,
         9.40555822665642194e-01L,  9.40293393587044779e-01L,
         9.03667933122363709e-01L,  5.94664250255206750e-01L,
         2.42786761650193278e-01L,  8.84801159116989193e-03L,
        -2.89852089602761574e-03L, -4.25675994574574706e-03L,
        -6.48752153715503443e-03L, -8.50330501837922789e-03L,
        -8.08558234579853478e-03L, -7.87638842794667442e-03L,
        -7.40535001955268911e-03L, -7.87325537177729383e-06L,
         5.11044452276384394e-03L, -2.61121726185305951e-03L
};
constexpr ComputeType REFLECTANCE_BLUE[] =
{
         9.33691696784997971e-01L,  9.30554487242068795e-01L,
         9.36790544643618106e-01L,  9.36699035009322611e-01L,
         9.33425130926987645e-01L,  9.41371956197645021e-01L,
         9.40832106297760928e-01L,  9.41016965909016179e-01L,
         9.27049592782754228e-01L,  7.43772642209018398e-01L,
         5.27805703116197678e-01L,  3.11828508845327923e-01L,
         1.28863217016504494e-01L,  1.78013626466347052e-02L,
        -4.81196981618005510e-06L, -3.98996181178051497e-04L,
        -3.94658518076619082e-04L,  1.64443693872507748e-03L,
         3.57621026810711227e-03L, -5.18575830170023722e-04L,
        -4.11430089544337748e-05L,  7.14076761099206696e-03L,
         2.42770289560838883e-02L,  3.59213570601116458e-02L,
         4.65760733262096105e-02L,  4.66762149625706002e-02L,
         4.68821595497938004e-02L,  3.74954274187325326e-02L,
         2.87053919240396853e-02L,  1.99924498915997999e-02L,
         6.54992982931130487e-03L,  3.92767378450882033e-03L
};
constexpr ComputeType ILLUMINATION_WHITE[] =
{
         9.99758718979738337e-01L,  9.99930999905856988e-01L,
         9.99842665895965377e-01L,  9.98941815163887359e-01L,
         9.99494495689155049e-01L,  9.99969814842569193e-01L,
         1.00000000000000000e+00L,  9.99970111632965564e-01L,
         9.99614453413457782e-01L,  9.99916278496150057e-01L,
         9.99750255044686176e-01L,  9.99681274989924651e-01L,
         9.99999998852129202e-01L,  9.91798468528610422e-01L,
         9.80229460954901821e-01L,  9.76301335196127273e-01L,
         9.76010778894917941e-01L,  9.08095069216021344e-01L,
         9.04190445168269630e-01L,  8.58977246978449904e-01L,
         8.26430476974639894e-01L,  7.99336934896606621e-01L,
         7.90973039742123740e-01L,  7.77483465790555384e-01L,
         7.74052050582981321e-01L,  7.68243330750729259e-01L,
         7.62644077804233600e-01L,  7.60703102785250218e-01L,
         7.57564565150358304e-01L,  7.60720884197405023e-01L,
         7.61285346211635017e-01L,  7.63351741029576369e-01L
};
constexpr ComputeType ILLUMINATION_CYAN[] =
{
         9.79811284331509547e-01L,  9.73957446355250167e-01L,
         9.80878695834761838e-01L,  9.81792274659480380e-01L,
         9.81703756891326385e-01L,  9.82117065121785537e-01L,
         9.82205763799450682e-01L,  9.82434030534032887e-01L,
         9.81594427975398975e-01L,  9.82368443581561501e-01L,
         9.82048828085047676e-01L,  9.82027996472159992e-01L,
         9.81521794282230742e-01L,  9.82285323587399284e-01L,
         9.81624104776041673e-01L,  9.81475584564144077e-01L,
         9.81109410795381498e-01L,  9.60502391813570999e-01L,
         7.83182561998881921e-01L,  5.28705551134375229e-01L,
         2.55356958345797191e-01L,  8.29477941522552970e-02L,
        -1.00715496802035991e-02L, -1.04984515235456641e-02L,
        -9.63705499376183057e-03L, -1.03713542637451708e-02L,
        -4.36607487941939511e-03L, -6.91412391491710767e-03L,
        -8.18833227709511204e-03L, -4.78297286190513486e-03L,
        -3.92711124997238703e-03L, -1.08411049578022549e-02L
};
constexpr ComputeType ILLUMINATION_MAGENTA[] =
{
         8.96600288676197565e-01L,  9.15242190712992842e-01L,
         9.30778840288020826e-01L,  9.30384272477968177e-01L,
         9.33200852337744524e-01L,  9.28736445460404014e-01L,
         9.27300067656183447e-01L,  9.27768493485808143e-01L,
         9.35662094877090400e-01L,  9.37113065806626566e-01L,
         8.26481464605053451e-01L,  4.77159285778712583e-01L,
         7.27791546312164389e-02L,  7.60199638919342648e-05L,
        -1.99570902878477233e-03L, -9.72347343986914507e-04L,
        -6.68200706838817141e-11L, -2.35742689546206206e-04L,
         1.25055706151485733e-02L,  2.23747096554794411e-01L,
         4.57364226684038810e-01L,  7.86362739468988714e-01L,
         9.24148503791516696e-01L,  9.41157005086414977e-01L,
         9.19571313989557604e-01L,  8.81897688679645575e-01L,
         8.87117575419912763e-01L,  9.32145914563199063e-01L,
         8.50048862863173160e-01L,  9.25589978727541007e-01L,
         9.19279603035036197e-01L,  8.77494391633391935e-01L
};
constexpr ComputeType ILLUMINATION_YELLOW[] =
{
         2.39945568040254593e-03L,  3.42961112045928398e-03L,
        -1.26269947272943659e-04L,  3.12917721102018388e-04L,
        -2.23195080650396822e-04L, -4.33377343594716313e-05L,
        -2.11248218080369986e-04L, -6.74803452875773094e-05L,
         4.29548768797769973e-02L,  4.19397270888388518e-01L,
         8.90016010599027130e-01L,  8.93256410749155960e-01L,
         8.96272636164821668e-01L,  8.95994401492708925e-01L,
         8.96041420807616174e-01L,  8.96315232796874306e-01L,
         8.96060219719505335e-01L,  8.95912643515285878e-01L,
         8.96195089185438887e-01L,  8.96025116382689113e-01L,
         8.95704568700845694e-01L,  8.94602719371410116e-01L,
         8.68145705761048547e-01L,  7.28028333053039933e-01L,
         6.37614514188582282e-01L,  5.69268866350886138e-01L,
         5.23267298350776344e-01L,  5.14779345870821192e-01L,
         5.13650952092736590e-01L,  4.88568196785753750e-01L,
         4.84622005600119088e-01L,  5.03358347406754114e-01L
};
constexpr ComputeType ILLUMINATION_RED[] =
{
         4.72951914393156883e-02L,  4.80713649703425755e-02L,
         5.25205324779981289e-02L,  4.86106810722837859e-02L,
         3.99116942957274817e-02L,  3.28602454608468153e-02L,
         2.11135691425922908e-02L,  3.36994315494515981e-03L,
        -4.84804112407921271e-04L,  8.34143134312681066e-04L,
         3.22796707982639125e-04L, -3.74890232867073942e-04L,
        -8.08556143791855310e-05L, -1.06802754496434268e-04L,
        -1.25557736504242377e-04L, -1.73302660082325159e-04L,
        -4.31695086132819633e-04L,  2.35607096225945618e-02L,
         1.38895000776862343e-01L,  3.03161467457025713e-01L,
         4.95827718984512500e-01L,  6.60372914233102071e-01L,
         7.70611064994983774e-01L,  8.33285067692756676e-01L,
         8.54765439270473770e-01L,  8.63565436236833239e-01L,
         8.52394041255165269e-01L,  8.60410643453864310e-01L,
         8.42265586232836205e-01L,  8.56968930191632339e-01L,
         8.54651534728447682e-01L,  8.61978355424494858e-01L
};
constexpr ComputeType ILLUMINATION_GREEN[] =
{
         2.17568622846550166e-02L,  3.40831250987787895e-02L,
         5.36475165646937893e-03L,  6.14805646649691992e-03L,
         1.88105126370291715e-04L,  6.33399836345178977e-12L,
        -1.86921013668830301e-02L,  1.35461427985723755e-02L,
         2.42216001098705894e-03L,  2.80901699907381730e-01L,
         8.78708239181116291e-01L,  8.92933605330763602e-01L,
         8.92251579130957984e-01L,  8.95457005704939024e-01L,
         8.77525511998497820e-01L,  8.93677036776043709e-01L,
         8.96555288963231223e-01L,  8.95691238961417557e-01L,
         8.84318976568791548e-01L,  8.37743196946066582e-01L,
        -4.47664419648799525e-03L,  9.62244091631558472e-04L,
         5.76377674129609913e-03L,  6.39904627086344173e-04L,
         1.86648723553420534e-02L,  4.45033859193164332e-03L,
         1.25880873512279590e-03L,  1.41895557856919197e-04L,
        -5.58701896426500727e-03L,  8.86137116591208425e-03L,
         3.66418652695806174e-02L,  1.83719522073565525e-02L
};
constexpr ComputeType ILLUMINATION_BLUE[] =
{
         9.13768115893168420e-01L,  9.10999808297465852e-01L,
         9.12039514484670577e-01L,  9.10303132814217708e-01L,
         9.14584144437757485e-01L,  9.14455245867733635e-01L,
         9.14860923855133734e-01L,  9.14565329354237733e-01L,
         9.13024123111916941e-01L,  9.13846653607213288e-01L,
         9.01259879253261231e-01L,  2.81837992758238565e-01L,
        -1.66455652086292243e-03L, -1.12026237489411110e-03L,
        -1.24112443717971032e-03L, -1.12064931337236520e-03L,
        -1.66208874572471607e-03L,  1.09103796851702027e-03L,
        -1.39135690969234256e-03L, -1.12637946850997154e-03L,
        -1.52719272570988099e-03L, -1.06546130939737856e-03L,
         8.91838605396710893e-03L,  2.70439574000801430e-02L,
         7.67407519735830435e-02L,  1.19930791169770415e-01L,
         1.34293191415026908e-01L,  1.28617283417222311e-01L,
         1.43708697013473802e-01L,  1.46936202274066396e-01L,
         1.36321856641244799e-01L,  1.64843121459506775e-01L
};
// clang-format on

template <std::size_t COUNT>
std::vector<float> rgb_samples(const ComputeType (&samples)[COUNT], int from, int to, int count)
{
        static_assert(COUNT == 32);

        return average<float>(std::to_array(WAVES), std::to_array(samples), from, to, count);
}
}

std::vector<float> rgb_reflectance_white_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_WHITE, from, to, count);
}

std::vector<float> rgb_reflectance_cyan_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_CYAN, from, to, count);
}

std::vector<float> rgb_reflectance_magenta_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_MAGENTA, from, to, count);
}

std::vector<float> rgb_reflectance_yellow_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_YELLOW, from, to, count);
}

std::vector<float> rgb_reflectance_red_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_RED, from, to, count);
}

std::vector<float> rgb_reflectance_green_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_GREEN, from, to, count);
}

std::vector<float> rgb_reflectance_blue_samples(int from, int to, int count)
{
        return rgb_samples(REFLECTANCE_BLUE, from, to, count);
}

std::vector<float> rgb_illumination_white_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_WHITE, from, to, count);
}

std::vector<float> rgb_illumination_cyan_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_CYAN, from, to, count);
}

std::vector<float> rgb_illumination_magenta_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_MAGENTA, from, to, count);
}

std::vector<float> rgb_illumination_yellow_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_YELLOW, from, to, count);
}

std::vector<float> rgb_illumination_red_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_RED, from, to, count);
}

std::vector<float> rgb_illumination_green_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_GREEN, from, to, count);
}

std::vector<float> rgb_illumination_blue_samples(int from, int to, int count)
{
        return rgb_samples(ILLUMINATION_BLUE, from, to, count);
}
}
